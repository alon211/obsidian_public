name: Sync to Notion

on:
  push:
    branches: [main, fix/**, test/**, '**']  # main + fix/test 前缀的分支
  workflow_dispatch:  # 允许手动触发

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整的 git 历史，确保使用最新代码

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install httpx markdown2
          pip install "notion-client>=2.2.1,<3.0.0"
          pip show notion-client | grep Version

      - name: Sync to Notion
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          GITHUB_WORKSPACE: ${{ github.workspace }}
          GITHUB_REPO: alon211/obsidian_public
          GITHUB_BRANCH: ${{ github.ref_name }}
        run: |
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          echo "NOTION_TOKEN length: ${#NOTION_TOKEN}"
          echo "NOTION_DATABASE_ID: $NOTION_DATABASE_ID"
          echo "GITHUB_REPO=$GITHUB_REPO"
          echo "GITHUB_BRANCH=$GITHUB_BRANCH"
          python3 .github/scripts/sync_notion.py
