name: Sync to Notion

on:
  push:
    branches: [main]
  workflow_dispatch:  # 允许手动触发

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests notion-client markdown2

      - name: Debug - Check environment variables
        run: |
          echo "Checking secrets..."
          if [ -z "${{ secrets.NOTION_TOKEN }}" ]; then
            echo "ERROR: NOTION_TOKEN secret is not set"
            echo "Please check at: https://github.com/alon211/obsidian_public/settings/secrets/actions"
          else
            echo "NOTION_TOKEN is set (length: ${#NOTION_TOKEN})"
          fi
          if [ -z "${{ secrets.NOTION_DATABASE_ID }}" ]; then
            echo "ERROR: NOTION_DATABASE_ID secret is not set"
          else
            echo "NOTION_DATABASE_ID is set (length: ${#NOTION_DATABASE_ID})"
          fi
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}

      - name: Sync to Notion
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: |
          python3 .github/scripts/sync_notion.py
